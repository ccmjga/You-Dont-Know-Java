# ã€Šä½ ä¸çŸ¥é“çš„ JAVA ç³»åˆ—åšå®¢ã€‹ğŸ”¥ åˆ†é¡µæŸ¥è¯¢çš„è¾¾èŠ¬å¥‡å¯†ç 

## å‰è¨€

ä½ å¯èƒ½å¾ˆç†Ÿæ‚‰ Mybatisï¼Œä½†æ˜¯ä»Šå¤©æˆ‘ä»¬ä¸è®²è¿™ä¸ªåŸºäºå­—ç¬¦ä¸²æ‹¼æ¥çš„ä¸Šå¤æ—¶ä»£çš„åº“ã€‚ä»Šå¤©æˆ‘ä»¬è°ˆä¸€ä¸ªåŸºäº QueryDSL å®ç°çš„åº“ã€‚ï¼ˆè¿™ä¸ªåº“ç¬¬ä¸€ä¸ªç‰ˆæœ¬è¯ç”Ÿè‡ª 2009å¹´ï¼‰ï¼Œä»–å«åš JOOQã€‚

JOOQ å¯ä»¥ç”¨ä¸€å¥è¯æ€»ç»“ï¼šå½“ä½ åœ¨ä½¿ç”¨ JOOQ çš„æ—¶å€™ï¼Œä½ å°±æ˜¯åœ¨ä½¿ç”¨ SQLï¼›ä¸€åˆ‡ä½ èƒ½å¤Ÿåœ¨ SQL æ ‡å‡†ä¸‹å®ç°çš„æ“ä½œï¼Œå‡ ä¹éƒ½èƒ½åœ¨ JOOQ ä»¥ç›¸åŒçš„æ–¹å¼å®ç°ã€‚

è®°ä½è¿™å¥è¯ï¼Œä½ å°±ç†è§£äº†æ•´ä¸ªJOOQ çš„è®¾è®¡æ€æƒ³ã€‚

> JOOQ å°±æ˜¯ç±»å‹å®‰å…¨çš„ã€å¯å¤ç”¨ã€å’Œå¯ä»¥ Debug çš„ SQLã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å›å½’åˆ†é¡µæŸ¥è¯¢çš„ä¸»é¢˜ã€‚

## Offset & Limit

æ™®é€šçš„åˆ†é¡µæŸ¥è¯¢å†™èµ·æ¥å¾ˆå®¹æ˜“ï¼ŒJOOQ å°±æ˜¯ SQLï¼Œæ‰€ä»¥ä»–çš„ Java API å’Œ SQL ä¸€æ¨¡ä¸€æ ·ã€‚

**SQL**

```sql
SELECT username FROM user LIMIT 2 OFFSET 1;
```

**JOOQ**

```java
List<User> users = dsl.select(USER.USERNAME).from(USER).limit(2).offset(1).fetchInto(User.class);
```

## OrderBy

**SQL**

```sql
SELECT username FROM user ORDER BY id DESC LIMIT 3 OFFSET 1;
```

**JOOQ**

```java
List<User> users = dsl.select(USER.USERNAME)
        .from(USER)
        .orderBy(USER.ID.desc())
        .limit(3)
        .offset(1)
        .fetchInto(User.class);
```

ä¸Šé¢çš„éƒ½å¾ˆç®€å•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ã€‚

## Ties

`USER` è¡¨ä¸­æœ‰5è¡Œæ•°æ®ï¼Œå…¶æœ€åä¸‰è¡Œçš„ password å€¼æ˜¯ç›¸åŒçš„ï¼›æˆ‘ä»¬çš„éœ€æ±‚æ˜¯æŒ‰ `password asc` æ’åºæŸ¥è¯¢å‡ºå‰ä¸‰æ¡ç»“æœã€‚

| id  | username  | password |
|-----|-----------|----------|
| 1   | testUserA | a        |
| 2   | testUserB | b        |
| 3   | testUserC | c        |
| 4   | testUserD | c        |
| 5   | testUserE | c        |

è¿™ä¸ªéœ€æ±‚æ»¡è¶³èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä½¿ç”¨ä¼ ç»Ÿçš„ `order by & limit offset` å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚

```java
List<User> users = dsl.select(USER.USERNAME)
        .from(USER)
        .orderBy(USER.PASSWORD.asc())
        .limit(3)
        .offset(0)
        .fetchInto(User.class);
```

ä½†é—®é¢˜æ˜¯è®°å½•ä¸­æœ‰ 3 è¡Œæ•°æ®çš„ password æ˜¯ç›¸åŒçš„ï¼Œåœ¨ä¸šåŠ¡ä¸Š `testUserC testUserD testUserE`  å®é™…æ‹¥æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³é—æ¼è¿™äº›ç›¸åŒä¼˜å…ˆçº§çš„æ•°æ®åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

è¿™å°±åˆ°äº† `withTies` ä¸Šåœºçš„æ—¶å€™äº†ï¼šå®ƒä¼šè¿”å›æŸ¥è¯¢ç»“æœé›†ä¸­å’Œæœ€åä¸€æ¡æ•°æ®ä¼˜å…ˆçº§ç›¸åŒçš„æ•°æ®ã€‚

```java
 @Test
  @Sql(
      statements = {
        "INSERT INTO mjga.user (id, username, password) VALUES (1, 'testUserA','a')",
        "INSERT INTO mjga.user (id, username, password) VALUES (2, 'testUserB','b')",
        "INSERT INTO mjga.user (id, username, password) VALUES (3, 'testUserC','c')",
        "INSERT INTO mjga.user (id, username, password) VALUES (4, 'testUserD','c')",
        "INSERT INTO mjga.user (id, username, password) VALUES (5, 'testUserE','c')"
      })
  void fetchAndTiesQuery() {
    List<User> users =
        dsl.select(USER.USERNAME)
            .from(USER)
            .orderBy(USER.PASSWORD.asc())
            .limit(3)
            .withTies()
            .offset(0)
            .fetchInto(User.class);
    assertThat(users.size()).isEqualTo(5);
    assertThat(users.get(0).getUsername()).isEqualTo("testUserA");
    assertThat(users.get(4).getUsername()).isEqualTo("testUserE");
  }
```

ä¸Šä¾‹æˆ‘ä»¬æŒ‡å®šäº† `limit 3 offset 0` ä½†å´æŸ¥è¯¢å‡ºäº† 5 æ¡ç»“æœï¼ŒåŸå› å°±æ˜¯ testUserD å’Œ testUserE å’Œ testUserC å½¢æˆäº†ç»‘å®šï¼ˆwithTiesï¼‰å…³ç³»ã€‚

è¿™æ˜¯ä»€ä¹ˆ JOOQ çš„ç¥å¥‡é­”æ³•å—ï¼Ÿä¸æ˜¯ï¼Œè¿™æ˜¯ SQL çš„æ ‡å‡†åŠŸèƒ½ï¼Œä½†æ˜¯ Mysql å´ä¸æ”¯æŒå®ƒï¼›è€Œè¯¸å¦‚ Mybatis ä¹‹ç±»çš„åº“åˆæ²¡æœ‰åœ¨åº”ç”¨å±‚é¢æ¨¡æ‹Ÿè¿™ä¸ªè¡Œä¸ºï¼Œè¿™å¯¼è‡´äº†ä½ æ²¡æœ‰æ¥è§¦è¿‡å®ƒã€‚

## Window Function

å†æ¥ä¸ªæ›´é«˜çº§ç‚¹çš„ä¾‹å­ï¼šå¾ˆå¤šæ—¶å€™åˆ†é¡µæŸ¥è¯¢éƒ½éœ€è¦æˆ‘ä»¬é¢å¤–ç»Ÿè®¡ä¸€ä¸ªã€Œæ€»æ•°ã€ã€‚æ— è®ºä½ ç”¨ä»€ä¹ˆåº“æˆ–æ’ä»¶ï¼Œå…¶åŸç†éƒ½æ˜¯é€šè¿‡å†è¿è¡Œä¸€ä¸ª `SELECT COUNT(*) AS total_count` ä¹‹ç±»çš„èšåˆæŸ¥è¯¢æ¥æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼Œè¿™ä¼šå¯¼è‡´ä½ å’Œ DB å¤šäº¤äº’ä¸€æ¬¡ã€‚

æ‰€ä»¥èƒ½ä¸èƒ½åªå’Œ DB äº¤äº’ä¸€æ¬¡ï¼Œå°±åŒæ—¶è·å–æŸ¥è¯¢ç»“æœé›†å’Œç»Ÿè®¡æ€»æ•°å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œçª—å£å‡½æ•°å¯ä»¥æŠŠç»“æœé›†è§†ä¸ºä¸€ä¸ªçª—å£ï¼Œä¸ºè¿™ä¸ªç»“æœé›†çš„æ¯ä¸€è¡Œè®¡ç®—ä¸€ä¸ªèšåˆå€¼ï¼Œè€Œä¸æ”¹å˜ç»“æœé›†çš„è¡Œæ•°ã€‚

**SQL**

```sql
SELECT *, COUNT(*) OVER () AS total_user
FROM user
ORDER BY id ASC
LIMIT 4 OFFSET 0;
```

**JOOQ**
ä¸è¦è¢« `Result<Record>` å“åˆ°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ `List<Map>` ç»“æ„ã€‚

```java
Result<Record> resultWithWindow = dsl.select(asterisk(), DSL.count().over().as("total_user"))
        .from(USER)
        .orderBy(USER.ID.asc())
        .limit(4)
        .offset(0)
        .fetch();
```

## Result<Record>

| id  | username | total_user |
|-----|----------|------------|
| 1   | Alice    | 5          |
| 2   | Bob      | 5          |
| 3   | Charlie  | 5          |
| 4   | David    | 5          |

è¿™æ˜¯ä»€ä¹ˆ JOOQ çš„ç¥å¥‡é­”æ³•å—ï¼Ÿä¸æ˜¯ï¼Œè¿™æ˜¯ SQL çš„æ ‡å‡†åŠŸèƒ½ï¼Œä½†æ˜¯ Mysql 8 ä»¥ä¸‹çš„ç‰ˆæœ¬å´ä¸æ”¯æŒå®ƒï¼›å¦‚æœä½ é•¿æœŸä½¿ç”¨ Mybatis-plus ç­‰ç›¸å…³æ’ä»¶ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´ä½ é”™è¿‡çª—å£å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ²¡æœ‰æä¾›å¯¹è¿™äº›å¸¸è§ SQL æ ‡å‡†çš„æ”¯æŒã€‚

## å¦‚æœä½ å–œæ¬¢ SQL

é‚£ä½ ä¸€å®šä¼šå–œæ¬¢ JOOQ å¸®ä½ æŠŠ Mybatis çš„ã€Œè¿è¡Œæ—¶å¼‚å¸¸ã€æå‰åˆ°ã€Œç¼–è¯‘æ—¶å¼‚å¸¸ã€çš„æœºåˆ¶ï¼›åƒè¿™æ ·çš„ç±»å‹å®‰å…¨çš„ã€å¯å¤ç”¨ã€å¯ Debug çš„ SQL å°†ä¼šé¢ è¦†ä½ è‡³ä»Šå·²æ¥çš„ SQL ç¼–ç ä½“éªŒã€‚

## å†™åœ¨æœ€å

- æˆ‘æ˜¯ Chuck1snï¼Œä¸€ä¸ªé•¿æœŸè‡´åŠ›äºç°ä»£ Jvm ç”Ÿæ€æ¨å¹¿çš„å¼€å‘è€…ã€‚
- æ‚¨çš„å›å¸–ã€ç‚¹èµã€æ”¶è—ã€å°±æ˜¯æˆ‘æŒç»­æ›´æ–°çš„åŠ¨åŠ›ã€‚
- ä¸¾æ‰‹ä¹‹åŠ³çš„ä¸€é”®ä¸‰è¿ï¼Œå¯¹æˆ‘æ¥è¯´æ˜¯è«å¤§çš„æ”¯æŒï¼Œéå¸¸æ„Ÿè°¢ï¼
- å…³æ³¨æˆ‘çš„è´¦å·ï¼Œç¬¬ä¸€æ—¶é—´æ”¶åˆ°æ–‡ç« æ¨é€ã€‚

PSï¼šä»¥ä¸Šæ‰€æœ‰ä»£ç ç¤ºä¾‹ä½ éƒ½å¯ä»¥åœ¨ [Github ä»“åº“](https://github.com/ccmjga/mjga-scaffold/blob/main/src/test/java/com/zl/mjga/integration/persistence/JooqTutorialsTest.java)ä¸­æ‰¾åˆ°ã€‚å¦‚æœæœ‰å¸®åŠ©ï¼Œè¯·é¡ºæ‰‹ç‚¹ä¸€ä¸ª Star è¿™å¯¹æˆ‘æ˜¯å¾ˆå¤§çš„é¼“åŠ±ã€‚è°¢è°¢ï¼
