# ã€Šä½ ä¸çŸ¥é“çš„ JAVA ç³»åˆ—åšå®¢ã€‹ ğŸ’˜ å¤±ä¼ å·²ä¹… SQL JOIN æŸ¥è¯¢ç‹¬é—¨ç§˜ç±

## ä» Left Join è¯´èµ·

å‡è®¾ä½ æœ‰è¿™æ ·ä¸€ä¸ª n2n çš„å…³ç³»è¡¨ï¼Œä»£è¡¨ç”¨æˆ·å’Œè§’è‰²ä¹‹é—´çš„å…³ç³»ã€‚

![assets](assets/n2n.png)
é€šå¸¸é€šè¿‡ left join å»è¿æ¥è¿™ä¸‰å¼ è¡¨ï¼Œæ¥æŸ¥è¯¢å‡ºç”¨æˆ·åŠå…¶è§’è‰²çš„ä¿¡æ¯ã€‚

```sql
SELECT 
    u.id AS user_id,
    u.name AS user_name,
    r.name AS role_name
FROM 
    "user" u
LEFT JOIN 
    "user_role_map" urm ON u.id = urm.user_id
LEFT JOIN 
    "role" r ON urm.role_id = r.id;
```

| user_id | user_name | role_name |
|---------|-----------|-----------|
| 1       | Alice     | Admin     |
| 1       | Alice     | User      |
| 2       | Bob       | User      |
| 3       | Charlie   | Guest     |


æŸ¥è¯¢å‡ºçš„ç»“æœä¸­ï¼ŒAlice è¿™ä¸ªç”¨æˆ·å‡ºç°äº†ä¸¤æ¬¡ã€‚è¿™æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª "Flatten" çš„ç»“æœã€‚

è¿™æ ·çš„ç»“æœæ˜¯æ— æ³•è¿”å›ç»™å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨çš„ã€‚ä½ éœ€è¦è¿›è¡Œå¤„ç†ï¼ŒæŠŠé‡å¤çš„ç”¨æˆ·å½’çº³åˆ°ä¸€èµ·ä»¥åå†è¿”å›ç»™å®¢æˆ·ç«¯è¿›è¡Œå±•ç¤ºï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š

|user_id | user_name | user's_role_array | å¤‡æ³¨|
|--- | --- | --- | ---|
|1 | Alice | [(Admin),(User<List<Tag>>),(Vip<List<Level>>),...(n)] | è¯•æƒ³ä»»æ„èŠ‚ç‚¹éƒ½å¯èƒ½åµŒå¥—é«˜åº¦ä¸º n çš„å­æ ‘çš„æƒ…å†µï¼Œå„èŠ‚ç‚¹éœ€ç›´æ¥è¿”å› List\<Map\> çš„å½¢å¼ä¾›å‰ç«¯åœ¨ html çš„ `<li></li>` å’Œ `<select></select>` èŠ‚ç‚¹ä¸­å±•ç¤ºã€‚|
|2 | Bob | User | |
|3 | Charlie | Guest | |

ä¸å¹¸çš„æ˜¯è¿™æ ·çš„å¤„ç†éå¸¸éº»çƒ¦ï¼Œä½  join çš„è¡¨è¶Šå¤šè¿™ä¸ªä»£ç è¶Šä¸å¥½å†™ï¼Œä¸ç›¸ä¿¡ä½ å¯ä»¥è¯•è¯•ã€‚

## Group_contact

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šè§‰å¾— agg_string å’Œ group_contact ç­‰èšåˆå‡½æ•°ä¸€å®šç¨‹åº¦ä¸Šèƒ½å®ç°è¿™ä¸ªéœ€æ±‚ã€‚ä½†æ˜¯èšåˆå‡½æ•°äººå¦‚å…¶åï¼Œä½œç”¨ä¸ºã€Œèšåˆã€ã€‚
å›åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œä¸è¦å±€é™äºä¾‹å­ä¸­æ ‘çš„é«˜åº¦ï¼Œè¯•æƒ³ä»»æ„èŠ‚ç‚¹éƒ½å¯èƒ½åµŒå¥—ä¸€é¢—é«˜åº¦ä¸º n çš„å­æ ‘ï¼Œå¹¶ä¸”ä½ çš„ä¸šåŠ¡é€»è¾‘è¿˜éœ€è¦å¯¹å­æ ‘çš„èŠ‚ç‚¹åšæ•°æ®ç»“æ„çš„è½¬æ¢ã€‚æ˜¾ç„¶ï¼Œå­—ç¬¦ä¸²çš„ã€Œèšåˆã€åœ¨è§£å†³è¿™æ ·å¤æ‚æ ‘ç»“æ„çš„é—®é¢˜æ—¶æ˜¾å¾—åŠ›é‡ä¸è¶³ã€‚

è¿™æ ·çš„å¤æ‚æ ‘ç»“æ„æ˜¯å¦å¾ˆå¸¸è§ï¼Ÿä¸ï¼Œå®ƒä¸å¸¸è§ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸å°‘è§ã€‚å› ä¸ºé™¤äº†äº’è”ç½‘ï¼Œè¿˜æœ‰å¾ˆå¤šè¡Œä¸šä¹Ÿåœ¨ä½¿ç”¨æ•°æ®åº“æ”¯æ’‘ä»–ä»¬çš„ä¸šåŠ¡ã€‚

## è°ˆè°ˆ ORM

æœ‰æ²¡æœ‰æ–¹ä¾¿çš„æ–¹æ³•æ¥è·å–è¿™ä¸ªã€ŒåµŒå¥—ã€çš„ç»“æœå‘¢ï¼Ÿä½¿ç”¨ Hibernate è¿™æ ·çš„ ORM æ¡†æ¶æ˜¯ä¸ªä¸é”™çš„ä¸»æ„ï¼š

```java
@Entity
public class User {
    @Id
    private int id;

    @Column(name = "name", nullable = false)
    private String name;

    @ManyToMany
    @JoinTable(
        name = "user_role_map",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles;
}

@Entity
public class Role {
    @Id
    private int id;

    @Column(name = "name", nullable = false)
    private String name;

    @ManyToMany(mappedBy = "roles")
    private Set<User> users;
}

```

Hibernate ç›´æ¥å¸®ä½ æŠŠæ•°æ®åº“çš„ç»“æœæ˜ å°„åˆ°äº†åµŒå¥—ç»“æœé›†ä¸­ã€‚ç°åœ¨ä½ å¯ä»¥ç›´æ¥æŠŠ `List<User>` è¿”å›ç»™å®¢æˆ·ç«¯äº†ï¼Œå› ä¸ºè¿™ä¸ªç»“æœç°åœ¨å±•ç¤ºä¸ºï¼š

|user_id | user_name | user's_role_array | å¤‡æ³¨|
|--- | --- | --- | ---|
|1 | Alice | [(Admin),(User<List<Tag>>),(Vip<List<Level>>),...(n)] | æ— è®ºæ ‘çš„å½¢çŠ¶å’Œé«˜åº¦ï¼ŒHibernate æŠŠå„èŠ‚ç›´æ¥æ˜ å°„ä¸º List\<Map\> çš„å½¢å¼ä¾›å‰ç«¯åœ¨ html çš„ `<li></li>` å’Œ `<select></select>` èŠ‚ç‚¹ä¸­å±•ç¤ºã€‚|
|2 | Bob | User | |
|3 | Charlie | Guest | |

### Hibernate çš„é—®é¢˜

ä½¿ç”¨ Hibernate çš„ä»£ä»·å°±æ˜¯ä½ çš„å¿ƒæ™ºè´Ÿæ‹…å¾ˆå¤§ã€‚é™¤äº†è¦å­¦ä¹ å¾ˆå¤šæ³¨è§£ä»¥å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå¤¸å¼ çš„æ¦‚å¿µéœ€è¦æ·±å…¥ç†è§£ï¼Œæ‰èƒ½å¤Ÿå†™å‡ºèƒ½æ­£å¸¸è¿è¡Œçš„ä»£ç ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ SQL çš„æ–¹å¼ï¼Œç›´æ¥æŸ¥è¯¢å‡ºè¿™ç§åµŒå¥—çš„ç»“æœé›†ï¼Œ ç„¶åæ‰”ç»™å®¢æˆ·ç«¯è¿›è¡Œå¤„ç†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ã€‚

## å…¨æ–°çš„è§£å†³æ–¹æ¡ˆ

```java
public static void main(String[] args) {
        UserRoleEntity userRoleEntity = select(
                USER.ID,
                USER.NAME,
                array(select(ROLE.ID, ROLE.NAME)
                        .from(ROLE)
                        .join(USER_ROLE_MAP).on(ROLE.ID.eq(USER_ROLE_MAP.ROLE_ID))
                        .where(USER_ROLE_MAP.USER_ID.eq(USER.ID))
                ).as("roles")
        ).from(USER);
        System.out.println(userRoleEntity);
    }


class UserRoleEntity {
    private Long id;
    private String name;
    private List<Role> roles;
}

```

æ˜¯çš„ï¼Œå¦‚ä½ æ‰€è§ï¼Œä½¿ç”¨ JOOQï¼Œ**é€šè¿‡åœ¨  Java çš„ main æ–¹æ³•é‡Œé¢ç”¨ Java è¯­è¨€æ¥ç¼–å†™ã€Œç±»å‹å®‰å…¨çš„ SQLã€å¹¶é€šè¿‡ Array æ–¹æ³•ä¸€é”®è½¬æ¢ä¸ºåµŒå¥—å¯¹è±¡**ï¼Œå…å»äº†å­¦ä¹  Hibernate çš„çƒ¦æ¼ã€‚


## å†™åœ¨æœ€å

- æˆ‘æ˜¯ Chuck1snï¼Œä¸€ä¸ªé•¿æœŸè‡´åŠ›äºç°ä»£ Jvm ç”Ÿæ€æ¨å¹¿çš„å¼€å‘è€…ã€‚
- æ‚¨çš„å›å¸–ã€ç‚¹èµã€æ”¶è—ã€å°±æ˜¯æˆ‘æŒç»­æ›´æ–°çš„åŠ¨åŠ›ã€‚
- ä¸¾æ‰‹ä¹‹åŠ³çš„ä¸€é”®ä¸‰è¿ï¼Œå¯¹æˆ‘æ¥è¯´æ˜¯è«å¤§çš„æ”¯æŒï¼Œéå¸¸æ„Ÿè°¢ï¼
- å…³æ³¨æˆ‘çš„è´¦å·ï¼Œç¬¬ä¸€æ—¶é—´æ”¶åˆ°æ–‡ç« æ¨é€ã€‚

PSï¼šä»¥ä¸Šæ‰€æœ‰ä»£ç ç¤ºä¾‹ä½ éƒ½å¯ä»¥åœ¨ [Github ä»“åº“](https://github.com/ccmjga/mjga-scaffold)ä¸­æ‰¾åˆ°ã€‚å¦‚æœæœ‰å¸®åŠ©ï¼Œè¯·é¡ºæ‰‹ç‚¹ä¸€ä¸ª Star è¿™å¯¹æˆ‘æ˜¯å¾ˆå¤§çš„é¼“åŠ±ã€‚è°¢è°¢ï¼
